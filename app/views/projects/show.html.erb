<%= turbo_refreshes_with method: :morph, scroll: :preserve %>
<%= turbo_stream_from @project %>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="flex justify-between items-start mb-8">
    <div>
      <div class="flex items-center gap-2 mb-2">
        <%= link_to "‚Üê Projects", root_path, class: "text-gray-600 hover:text-gray-900" %>
      </div>
      <div class="flex items-center gap-3">
        <h1 class="text-3xl font-bold text-gray-900"><%= @project.name %></h1>
        <button type="button"
                data-controller="clipboard"
                data-action="click->clipboard#copy"
                data-clipboard-text-value="<%= @project.dsn %>"
                class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-1.5 px-3 rounded-lg">
          Copy External DSN
        </button>
        <% if @project.internal_dsn.present? %>
          <button type="button"
                  data-controller="clipboard"
                  data-action="click->clipboard#copy"
                  data-clipboard-text-value="<%= @project.internal_dsn %>"
                  class="bg-green-600 hover:bg-green-700 text-white text-sm font-semibold py-1.5 px-3 rounded-lg">
            Copy Internal DSN
          </button>
        <% end %>
      </div>
      <div class="mt-2 space-y-1">
        <p class="text-xs text-gray-600">
          <span class="font-semibold">External:</span>
          <code class="text-gray-800 bg-gray-100 px-2 py-0.5 rounded"><%= @project.dsn %></code>
        </p>
        <% if @project.internal_dsn.present? %>
          <p class="text-xs text-gray-600">
            <span class="font-semibold">Internal:</span>
            <code class="text-gray-800 bg-gray-100 px-2 py-0.5 rounded"><%= @project.internal_dsn %></code>
          </p>
        <% end %>
      </div>
      <p class="text-gray-600 mt-1">/<%= @project.slug %></p>
    </div>
    <div class="flex gap-2">
      <%= link_to "Edit", edit_project_path(@project.slug), class: "text-gray-600 hover:text-gray-900" %>
      <%= button_to "Delete", project_path(@project.slug), method: :delete,
          data: { turbo_confirm: "Are you sure? This will delete all events and issues." },
          class: "text-red-600 hover:text-red-800" %>
    </div>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-2 md:grid-cols-6 gap-6 mb-8">
    <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
      <div class="text-sm text-gray-600 mb-1">Open Issues</div>
      <div class="text-3xl font-bold text-red-600"><%= @project.issues.open.count %></div>
    </div>
    <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
      <div class="text-sm text-gray-600 mb-1">Events (24h)</div>
      <div class="text-3xl font-bold text-gray-900"><%= @event_count_24h %></div>
    </div>
    <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
      <div class="text-sm text-gray-600 mb-1">Transactions (24h)</div>
      <div class="<%= @transaction_count_24h > 99_999 ? 'text-2xl' : 'text-3xl' %> font-bold text-gray-900"><%= @transaction_count_24h %></div>
    </div>
    <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
      <div class="text-sm text-gray-600 mb-1">Avg Response</div>
      <div class="text-3xl font-bold text-gray-900"><%= @avg_response_time.round %>ms</div>
    </div>
    <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
      <div class="text-sm text-gray-600 mb-1">Queue Depth</div>
      <div class="text-3xl font-bold <%= @queue_depth > 10 ? 'text-yellow-600' : 'text-gray-900' %>"><%= @queue_depth %></div>
    </div>
    <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
      <div class="text-sm text-gray-600 mb-1">Error Rate</div>
      <div class="text-3xl font-bold <%= @project.error_rate > 5 ? 'text-red-600' : @project.error_rate > 1 ? 'text-yellow-600' : 'text-green-600' %>">
        <%= @project.error_rate %>%
      </div>
    </div>
  </div>


  <!-- Quick Links -->
  <div class="mb-8 grid grid-cols-1 md:grid-cols-3 gap-4">
    <%= link_to project_issues_path(@project.slug),
        class: "bg-white hover:bg-gray-50 rounded-lg shadow p-4 border border-gray-200 transition-colors" do %>
      <div class="text-sm text-gray-600 mb-1">üìã Issues</div>
      <div class="text-2xl font-bold text-gray-900"><%= @project.issues.open.count %></div>
      <div class="text-xs text-gray-500 mt-1">View all issues ‚Üí</div>
    <% end %>

    <%= link_to project_events_path(@project.slug),
        class: "bg-white hover:bg-gray-50 rounded-lg shadow p-4 border border-gray-200 transition-colors" do %>
      <div class="text-sm text-gray-600 mb-1">‚ö° Events</div>
      <div class="text-2xl font-bold text-gray-900"><%= @event_count_24h %></div>
      <div class="text-xs text-gray-500 mt-1">View all events ‚Üí</div>
    <% end %>

    <%= link_to project_transactions_path(@project.slug),
        class: "bg-white hover:bg-gray-50 rounded-lg shadow p-4 border border-gray-200 transition-colors" do %>
      <div class="text-sm text-gray-600 mb-1">üöÄ Performance</div>
      <div class="text-2xl font-bold <%= duration_color_class(@avg_response_time) %>"><%= format_duration(@avg_response_time) %></div>
      <div class="text-xs text-gray-500 mt-1">View performance ‚Üí</div>
    <% end %>
  </div>

  <!-- Recent Unresolved Issues -->
  <div class="mb-8">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold text-gray-900">Recent Open Issues</h2>
      <%= link_to "View All Issues ‚Üí", project_issues_path(@project.slug), class: "text-blue-600 hover:text-blue-800" %>
    </div>

    <% if @recent_issues.any? %>
      <div class="bg-white rounded-lg shadow border border-gray-200 divide-y divide-gray-200">
        <% @recent_issues.each do |issue| %>
          <%= link_to project_issue_path(@project.slug, issue), class: "block hover:bg-gray-50 p-4 transition-colors" do %>
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <h3 class="font-semibold text-gray-900 mb-1"><%= issue.title %></h3>
                <div class="flex items-center gap-4 text-sm text-gray-600">
                  <span><%= issue.exception_type %></span>
                  <span>‚Ä¢</span>
                  <span><%= issue.count %> events</span>
                  <span>‚Ä¢</span>
                  <span>Last seen <%= time_ago_in_words(issue.last_seen) %> ago</span>
                </div>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <div class="bg-white rounded-lg shadow p-8 text-center border border-gray-200">
        <p class="text-gray-600">No open issues üéâ</p>
      </div>
    <% end %>
  </div>

  <!-- Recent Transactions -->
  <div class="mb-8">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold text-gray-900">Recent Transactions</h2>
      <%= link_to "View All Transactions ‚Üí", project_transactions_path(@project.slug), class: "text-blue-600 hover:text-blue-800" %>
    </div>

    <% if @recent_transactions.any? %>
      <div class="bg-white rounded-lg shadow border border-gray-200 divide-y divide-gray-200">
        <% @recent_transactions.each do |transaction| %>
          <%= link_to project_transaction_path(@project.slug, transaction), class: "block hover:bg-gray-50 p-4 transition-colors" do %>
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <h3 class="font-medium text-gray-900"><%= transaction.transaction_name %></h3>
                  <%= render "http_status_badge", status: transaction.http_status %>
                </div>
                <div class="flex items-center gap-4 text-sm text-gray-600">
                  <span class="<%= duration_color_class(transaction.duration) %> font-medium">
                    <%= format_duration(transaction.duration) %>
                  </span>
                  <% if transaction.http_method.present? %>
                    <span>‚Ä¢</span>
                    <span><%= transaction.http_method.upcase %></span>
                  <% end %>
                  <% if transaction.environment.present? %>
                    <span>‚Ä¢</span>
                    <span><%= transaction.environment %></span>
                  <% end %>
                  <span>‚Ä¢</span>
                  <span><%= transaction.timestamp.strftime("%Y-%m-%d %H:%M:%S") %></span>
                </div>
                <% if transaction.slow? %>
                  <div class="mt-2">
                    <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-red-100 text-red-800">
                      üêå Slow transaction
                    </span>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <div class="bg-white rounded-lg shadow p-8 text-center border border-gray-200">
        <p class="text-gray-600">No transactions yet</p>
      </div>
    <% end %>
  </div>

  <!-- Recent Events -->
  <div>
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold text-gray-900">Recent Events</h2>
      <%= link_to "View All Events ‚Üí", project_events_path(@project.slug), class: "text-blue-600 hover:text-blue-800" %>
    </div>

    <% if @recent_events.any? %>
      <div class="bg-white rounded-lg shadow border border-gray-200 divide-y divide-gray-200">
        <% @recent_events.each do |event| %>
          <%= link_to project_event_path(@project.slug, event), class: "block hover:bg-gray-50 p-4 transition-colors" do %>
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <div class="flex items-center gap-3 mb-1">
                  <h3 class="font-medium text-gray-900"><%= event.message %></h3>
                  <% if event.issue.present? %>
                    <% if event.issue.resolved? %>
                      <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded">Resolved</span>
                    <% elsif event.issue.ignored? %>
                      <span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded">Ignored</span>
                    <% else %>
                      <span class="px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded">Open</span>
                    <% end %>
                  <% end %>
                </div>
                <div class="flex items-center gap-4 text-sm text-gray-600">
                  <span><%= event.exception_type %></span>
                  <% if event.issue.present? %>
                    <span>‚Ä¢</span>
                    <%= link_to project_issue_path(@project.slug, event.issue), class: "text-blue-600 hover:text-blue-800" do %>
                      Issue #<%= event.issue.id %>
                    <% end %>
                  <% end %>
                  <% if event.environment.present? %>
                    <span>‚Ä¢</span>
                    <span><%= event.environment %></span>
                  <% end %>
                  <span>‚Ä¢</span>
                  <span><%= event.timestamp.strftime("%Y-%m-%d %H:%M:%S") %></span>
                </div>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <div class="bg-white rounded-lg shadow p-8 text-center border border-gray-200">
        <p class="text-gray-600">No events yet</p>
      </div>
    <% end %>
  </div>
</div>
